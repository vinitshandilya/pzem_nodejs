<h1>PZEM-004T</h1>
<p><a href="https://pzem-nodejs-app.onrender.com/reading" target="_blank">GET reading</a></p>
<pre id="messages" style="height: 400px; overflow: scroll"></pre>


<script>
  (function() {
    const messages = document.querySelector('#messages');

    let ws;

    function showReading(message) {
      var reading = '';
	  const options = { 
	      year: 'numeric', 
	      month: 'numeric', 
	      day: 'numeric', 
	      hour: 'numeric', 
	      minute: 'numeric', 
	      second: 'numeric', 
	      timeZoneName: 'short' 
	  };
      try {
        var jObj = JSON.parse(message);
        console.log(jObj);
        for (var key in jObj) {
          if (jObj.hasOwnProperty(key)) {
              var val = jObj[key];
			  if(key === "timestamp") {
				  const timestampUTC = new Date(jObj.timestamp * 1000);
				  const timestampLocal = timestampUTC.toLocaleString(undefined, options);
				  reading += `${key}: ${timestampLocal}\n\n`
			  }
			  else {
			  	reading += `${key}: ${val}\n\n`
			  }   
          }
        }
      } catch(err) {
        console.log(`Can't parse response from server: ${message}`);
        messages.textContent = `${message}\n`;
      }
      messages.textContent = `\n\n${reading}`;
    }

    function init() {
      if (ws) {
        ws.onerror = ws.onopen = ws.onclose = null;
        ws.close();
      }

      ws = new WebSocket('wss://pzem-nodejs-app.onrender.com');
      ws.onopen = () => {
        console.log('Connection opened!');
      }
      ws.onmessage = ({ data }) => showReading(data);
      ws.onclose = function() {
        ws = null;
      }
    }

    init();
  })();

</script>